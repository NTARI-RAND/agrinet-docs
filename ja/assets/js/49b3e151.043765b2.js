"use strict";(globalThis.webpackChunkdocusaurus=globalThis.webpackChunkdocusaurus||[]).push([[8523],{3674:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var r=n(6540),a=n(8478),s=n(3667),o=n(4848);const l=(e,t)=>{if(!e)return t;return`${e.endsWith("/")?e.slice(0,-1):e}${t}`},i=()=>"undefined"!=typeof process&&process.env.AGRINET_REGISTRY_URL?process.env.AGRINET_REGISTRY_URL:"";function d({children:e,displayEndpoint:t,errorMessage:n,isUsingFallback:r}){return(0,o.jsx)(s.A,{title:"Global Map",description:"Monitor Agrinet node status and locations across the globe.",children:(0,o.jsx)("main",{className:"container margin-vert--lg",children:(0,o.jsxs)("div",{style:{padding:16},children:[(0,o.jsx)("h1",{children:"Agrinet Global Map"}),(0,o.jsxs)("p",{children:["The map polls ",(0,o.jsx)("code",{children:t})," every 30 seconds to keep node locations and status up to date. Set the",(0,o.jsx)("code",{children:"AGRINET_REGISTRY_URL"})," environment variable when building the docs if your registry is hosted on another domain. If the registry cannot be reached, the map falls back to the last published static dataset."]}),n&&(0,o.jsx)("div",{role:"status",style:{background:"#fff3cd",border:"1px solid #ffeeba",color:"#856404",borderRadius:6,padding:"12px 16px",marginBottom:16},children:n}),(0,o.jsx)("div",{style:{height:600,borderRadius:6,overflow:"hidden"},children:e}),(0,o.jsxs)("p",{style:{marginTop:12},children:[(0,o.jsx)("a",{href:"/data/global_map_layer.geojson",download:!0,children:"Download the latest published GeoJSON snapshot"}),r&&!n&&(0,o.jsx)("span",{style:{marginLeft:8},children:"(Currently displaying the fallback dataset.)"})]})]})})})}function c(){const e=i(),t=l(e,"/api/nodes")||"/api/nodes";return(0,o.jsx)(d,{displayEndpoint:t,errorMessage:null,isUsingFallback:!1,children:(0,o.jsx)("div",{style:{alignItems:"center",background:"#f8f9fa",color:"#495057",display:"flex",fontWeight:500,height:"100%",justifyContent:"center"},children:"Loading map\u2026"})})}function p(){const[e,t]=(0,r.useState)(null),[a,s]=(0,r.useState)(null),[c,p]=(0,r.useState)(!1),u=(0,r.useRef)(null),h=(0,r.useRef)(null),g=i(),f=(0,r.useMemo)(()=>l(g,"/api/nodes"),[g]),b=f||"/api/nodes",m=(0,r.useMemo)(()=>n(3481),[]),y=(0,r.useMemo)(()=>n(614),[]),{MapContainer:x,TileLayer:j,GeoJSON:_}=y,C=(0,r.useCallback)(e=>{const t=(e,t)=>{const n=document.createElement("div"),r=document.createElement("strong");return r.textContent=`${e}:`,n.appendChild(r),n.appendChild(document.createTextNode(` ${t}`)),n},n=document.createElement("div"),r=document.createElement("strong");r.textContent=e.node_name||"Unknown node",n.appendChild(r),n.appendChild(document.createElement("br")),n.appendChild(t("Status",e._isOnline?"Online":"Offline")),n.appendChild(t("Last seen",e.last_seen||"\u2014")),n.appendChild(t("Type",e.node_type||"\u2014")),n.appendChild(t("Email",e.contact_email||"\u2014"));const a=Array.isArray(e.languages)&&e.languages.join(", ")||"\u2014";n.appendChild(t("Languages",a));const s=Array.isArray(e.ping_categories)&&e.ping_categories.join(", ")||"\u2014";n.appendChild(t("Categories",s));const o=(e=>{if(!e||"string"!=typeof e)return null;try{const t=new URL(e);if("http:"===t.protocol||"https:"===t.protocol)return t.href}catch(t){return null}return null})(e.fork_repo);if(o){const e=document.createElement("div"),t=document.createElement("a");t.href=o,t.target="_blank",t.rel="noopener noreferrer",t.textContent="Fork repo",e.appendChild(t),n.appendChild(e)}return n},[]);return(0,r.useEffect)(()=>{let e=!0;const n=new AbortController,r=async(a=!1)=>{const o=a?"/data/global_map_layer.geojson":f;try{const r=await fetch(o,{cache:"no-store",signal:n.signal});if(!r.ok)throw new Error(`${r.status} ${r.statusText}`);const l=await r.json();if(e){const e=(e=>{const t=Date.now(),n=(e.features||[]).map(e=>{const n=e.properties||{},r=n.last_seen?Date.parse(n.last_seen):void 0,a="number"==typeof r&&!Number.isNaN(r)&&t-r<=3e5;return{...e,properties:{...n,_isOnline:Boolean(a)}}});return{...e,features:n}})(l);t(e),a?(p(!0),s("Live registry is unavailable. Displaying the last published snapshot.")):(p(!1),s(null))}}catch(l){if("AbortError"===l.name)return;a?(console.error("Failed to load fallback GeoJSON:",l),e&&(p(!1),s("Unable to load registry or fallback data. Please try again later."))):(console.error("Failed to load nodes from registry:",l),r(!0))}};r();const a=window.setInterval(()=>r(),3e4);return()=>{e=!1,n.abort(),window.clearInterval(a)}},[f]),(0,r.useEffect)(()=>{if(e&&u.current&&h.current)try{const t=h.current.geoJSON(e).getBounds();t&&"function"==typeof t.isValid&&!t.isValid()||u.current.fitBounds(t,{padding:[20,20]})}catch(t){console.warn("Could not fit bounds:",t)}},[e,m]),(0,o.jsx)(d,{displayEndpoint:b,errorMessage:a,isUsingFallback:c,children:(0,o.jsxs)(x,{center:[0,0],zoom:2,style:{height:"100%",width:"100%"},whenCreated:e=>{u.current=e},children:[(0,o.jsx)(j,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"\xa9 OpenStreetMap contributors"}),e&&(0,o.jsx)(_,{data:e,pointToLayer:(e,t)=>{const n=e?.properties?._isOnline,r=n?"#2b87ff":"#7a7a7a";return m.circleMarker(t,{radius:8,color:r,fillColor:r,weight:2,fillOpacity:n?.8:.35})},onEachFeature:(e,t)=>{const n=e.properties||{},r=C({...n,last_seen:n.last_seen&&!Number.isNaN(new Date(n.last_seen))?new Date(n.last_seen).toLocaleString():"\u2014"});t.bindPopup(r)}})]})})}const u=()=>(0,o.jsx)(a.A,{fallback:(0,o.jsx)(c,{}),children:()=>(0,o.jsx)(p,{})})}}]);